# 雑多なTIPS

後々、ちゃんとしたドキュメントを書く予定ですが、ひとまずdaisy-toolsを使用する上でのあれこれを書き並べておきます。

## HOWTO

### `dsy-*`系のツールで細胞ファイルやコード化合物ファイルを指定する際は`cell`ディレクトリや`code`ディレクトリ内のファイル名で指定する

例えば、`cell`ディレクトリ内の`0cbb3f5a50`という細胞ファイルの内容を`dsy-dump-cell`で表示する際は、`bin/dsy-dump-cell 0cbb3f5a50`となる。

### 周期処理の間にウェイト時間を設定する方法

`dsy-sysenv`のコマンドライン引数(第1引数)にマイクロ秒単位で指定する。(デフォルトは`1000000`(1秒))

ウェイト時間10秒で実行する例：

```bash
$ bin/dsy-sysenv 10000000
```

### 適応度100の細胞が生まれても`dsy-sysenv`を終了させないで動作させ続ける方法(エンドレスモード)

daisy-toolsを実行したディレクトリ(`running`ファイルが置かれるディレクトリ)に`endless`という名前のファイルを置く。

`endless`ファイルの配置/削除はdaisy-toolsの実行中に行っても良い。(`endless`ファイルの存在確認は、細胞の評価結果が適応度が100になる度に行われるため。)

### エンドレスモードの有効化を設定するファイルのファイル名を変える方法

デフォルトは"endless"というファイル名。

これを変更したい場合は、[`dsy-sysenv/sysenv.h`の定数`ENDLESS_FILENAME`](https://github.com/cupnes/daisy-tools/blob/c576a5e95a24af27cafe396cfb0dca04771473e4/sysenv.h#L15)を書き換えれば良い。

### daisy-toolsの実行中に細胞ファイルを追加する方法

毎周期、`cell`ディレクトリ内の全ファイルをチェックしているので、単に`cell`ディレクトリにファイルを配置すれば自動的に認識される。

### daisy-toolsの実行中にコード化合物ファイルを追加する方法

起動時に`code`ディレクトリ内のファイルリストを作っているので、daisy-toolsを実行しながらファイルを追加したい場合は、以下の手順でdaisy-toolsへ再認識させる必要がある。

1. `code`ディレクトリにファイルを追加
2. daisy-toolsを実行したディレクトリ(`running`ファイルが置かれるディレクトリ)に`update_code`という名前のファイルを配置

この様にすると、次の周期の始めにコード化合物ファイルリストの更新が行われる。

### 細胞を突然死させる方法

#### 方法A：寿命を書き換える

手順：

1. daisy-toolsを停止させる
2. 対象の細胞ファイルの寿命を1にする
3. daisy-toolsを再開させる

備考：

- 細胞が持っていたコード化合物は`code`ディレクトリへ戻される

#### 方法B：細胞ファイルを消す

手順：

1. daisy-toolsを停止させる
2. 対象の細胞ファイルを消す
3. daisy-toolsを再開させる

備考：

- 細胞が持っていたコード化合物ごと消える

## 仕様など

### 現状の`dsy-sysenv`はエラー終了すると`running`ファイルが残るが、特に手動で消す必要は無い

[`dsy-sysenv`の起動時は、`running`ファイルが無ければ作るだけ](https://github.com/cupnes/daisy-tools/blob/c576a5e95a24af27cafe396cfb0dca04771473e4/sysenv.c#L137)

### 突然変異で進化した実行バイナリを評価時に実行することについて

daisy-toolsは代謝/運動の段階で`cell`ディレクトリに存在する細胞ファイルを`dsy-eval`を使って評価します。`dsy-eval`はユーザー定義ですが、大抵の場合、細胞ファイルをELFへ変換して実行してみる事で評価します。ただ、`cell`ディレクトリには突然変異した細胞ファイルも存在する可能性があるため、「突然変異したバイナリを安易に実行して良いのか」という懸念があります。ここでは、その懸念に対してdaisy-toolsではどのような対策を行っているのかを説明します。

基本方針として、daisy-toolsでは、突然変異の仕方を制限しています。ざっくりと説明すると、まず、突然変異は細胞の中の機械語バイナリ(機械語の命令列)の一つ一つの「命令」の単位で行います[^mutate_target]。その際、突然変異でどの命令になるか[^mutate_style]は環境に存在する命令の中からランダムで選びます。具体的には、`code`ディレクトリの中のコード化合物と`cell`ディレクトリの中の細胞が持っている命令の中から選びます。そのため、ユーザーが配置したコード化合物ファイルと細胞ファイルに含まれる命令の中でのみ突然変異が行われます。

また、合計8バイト以内であれば複数の命令をセットで1命令として扱うことができるようになっています[^multi_inst]。これを利用すると突然変異で実行され得るシステムコールを制限することができます。`syscall`命令は実行時、`RAX`レジスタの内容をシステムコール番号として扱います。そのため、突然変異により`syscall`命令の直前で`RAX`へどの様な値を設定されるかによって、期待しないシステムコールが細胞の評価時に実行されてしまう可能性があります。この場合、`RAX`レジスタへ値を設定する命令と`syscall`命令自体をセットで1命令とすることで、daisy-tools内では「XX番のシステムコールを実行する命令」という一つの命令として扱われます。これにより、daisy-tools内で実行して良いシステムコールを制限することができます。

以上の対策により、突然変異で変異する命令とシステムコールを制限することで、進化の過程である等で意図しない状態の細胞を実行しても起こるのは高々Segmentation faultくらいである様にしています。

また、別の対策として、「`dsy-eval`を工夫する」という方法もあります。`dsy-eval`はユーザー定義で実験に応じて変更するものです。例えば、細胞を評価する際にELFへ変換後、そのまま実行するのではなく`unshare`コマンドと`chroot`コマンドを組み合わせて実行することでPID名前空間とルートディレクトリを分ける事ができ、コンテナ内で実行するのと同様の事ができます([例](../samples/dsy-eval-exit_0-unshare#L14))。また、評価の内容によっては、ELFに変換して実行するのではなく、細胞ファイルのまま[`dsy-dump-cell`コマンド](../bin/README.md#dsy-dump-cell)でその中身をダンプした結果をパースして評価しても良いかもしれません。あるいは、ELFに変換した後、[`dsy-elf2asm`コマンド](../bin/README.md#dsy-elf2asm)で逆アセンブルした結果をパースするという評価方法も考えられます。

[^mutate_target]: 正確には、細胞の機械語バイナリの設計図であるDNAを構成するコドンの単位で突然変異を行います。DNAは細胞を構成するタンパク質の設計図です。daisy-toolsでは一つのタンパク質を機械語の1命令と対応付けて考えており、DNAの中のコドン一つが1命令の設計図であるとしています。(一部、例外的に2〜3命令程を一つのタンパク質としている場合もあります。)コドンといっても[実装としては単に1命令のバイナリ列と属性情報少しを持っているだけ](https://github.com/cupnes/daisy-tools/blob/8e0e6cbd90081b3aab7d715def0e13743cb2979d/cell.h#L56-L100)です。そのため、ざっくり説明すると「突然変異は命令単位」となります。
[^mutate_style]: 他にも命令が挿入されたり、命令が消されたり、という突然変異もあります。
[^multi_inst]: 1命令を設定する領域が8バイト分あるというだけですが

### 突然変異の仕様

突然変異はDNAを構成するコドンの単位で行われる。

突然変異の種別は以下の通り。

- [ランダムに選んだ命令をランダムに選んだコドンの直前に新たなコドンとして挿入する(`INSERT_PREV`)](https://github.com/cupnes/daisy-tools/blob/3ac67d0dc6faaa07269818e3fb6b3d4f53c59a17/cell.c#L490-L491)
- [ランダムに選んだ命令をランダムに選んだコドンの直後に新たなコドンとして挿入する(`INSERT_NEXT`)](https://github.com/cupnes/daisy-tools/blob/3ac67d0dc6faaa07269818e3fb6b3d4f53c59a17/cell.c#L494-L495)
- [ランダムに選んだコドンをランダムに選んだ命令のコドンへ変更する(`MODIFY`)](https://github.com/cupnes/daisy-tools/blob/3ac67d0dc6faaa07269818e3fb6b3d4f53c59a17/cell.c#L498-L499)
- [ランダムに選んだコドンを削除する(`REMOVE`)](https://github.com/cupnes/daisy-tools/blob/3ac67d0dc6faaa07269818e3fb6b3d4f53c59a17/cell.c#L502-L503)

なお、突然変異すると、寿命は突然変異した結果のコドン数に比例した値が設定される。計算式は以下の通り([Ref](https://github.com/cupnes/daisy-tools/blob/205bca87e693d22f2f2e8f245f8a0fbbff479766/cell.c#L514-L516))。

> 寿命 = 30 * コドン数 - 20

DNAが長くなるにつれ、それに応じて寿命も延びないと、「寿命が尽きるまでに必要なコード化合物を集めきれない」、ということになってしまう。そのため、コドン数に比例して寿命が長くなるようにしている。ただ、この一次関数の傾きや切片は経験的に決めたもので深い根拠は無いため、必要に応じて変更して構わない。(そもそも一次関数で無くても良いかもしれない。)
