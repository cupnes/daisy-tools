# 雑多なTIPS

後々、ちゃんとしたドキュメントを書く予定ですが、ひとまずdaisy-toolsを使用する上でのあれこれを書き並べておきます。

## HOWTO

### `dsy-*`系のツールで細胞ファイルやコード化合物ファイルを指定する際は`cell`ディレクトリや`code`ディレクトリ内のファイル名で指定する

例えば、`cell`ディレクトリ内の`0cbb3f5a50`という細胞ファイルの内容を`dsy-dump-cell`で表示する際は、`bin/dsy-dump-cell 0cbb3f5a50`となる。

### `cell-fitness-logger`の使い方

`samples/run`で実行すれば、`dsy-sysenv`と共に適切に起動される。

単体で実行する場合は以下の通り。

```bash
$ samples/cell-fitness-logger >>cell-fitness-logger.log 2>&1
```

### daisy-toolsの停止方法

`bin/run`あるいは`bin/dsy-sysenv`で起動されたdaisy-toolsのシステムは、`running`ファイルを消すことで停止できる。

### daisy-toolsの再開方法

前提: `running`ファイルを消す方法で停止していること。

`bin/run`あるいは`dsy-sysenv`を実行するだけでOK。(特に再開のための特別な作業は不要。)

### 周期処理の間にウェイト時間を設定する方法

`dsy-sysenv`のコマンドライン引数(第1引数)にマイクロ秒単位で指定する。(デフォルトは`1000000`(1秒))

ウェイト時間10秒で実行する例：

```bash
$ bin/dsy-sysenv 10000000
```

### 適応度100の細胞が生まれても`dsy-sysenv`を終了させないで動作させ続ける方法(エンドレスモード)

daisy-toolsを実行したディレクトリ(`running`ファイルが置かれるディレクトリ)に`endless`という名前のファイルを置く。

`endless`ファイルの配置/削除はdaisy-toolsの実行中に行っても良い。(`endless`ファイルの存在確認は、細胞の評価結果が適応度が100になる度に行われるため。)

### エンドレスモードの有効化を設定するファイルのファイル名を変える方法

デフォルトは"endless"というファイル名。

これを変更したい場合は、[`dsy-sysenv/sysenv.h`の定数`ENDLESS_FILENAME`](https://github.com/cupnes/daisy-tools/blob/c576a5e95a24af27cafe396cfb0dca04771473e4/sysenv.h#L15)を書き換えれば良い。

### daisy-toolsの実行中に細胞ファイルを追加する方法

毎周期、`cell`ディレクトリ内の全ファイルをチェックしているので、単に`cell`ディレクトリにファイルを配置すれば自動的に認識される。

### daisy-toolsの実行中にコード化合物ファイルを追加する方法

起動時に`code`ディレクトリ内のファイルリストを作っているので、daisy-toolsを実行しながらファイルを追加したい場合は、以下の手順でdaisy-toolsへ再認識させる必要がある。

1. `code`ディレクトリにファイルを追加
2. daisy-toolsを実行したディレクトリ(`running`ファイルが置かれるディレクトリ)に`update_code`という名前のファイルを配置

この様にすると、次の周期の始めにコード化合物ファイルリストの更新が行われる。

### 細胞を突然死させる方法

#### 方法A：寿命を書き換える

手順：

1. daisy-toolsを停止させる
2. 対象の細胞ファイルの寿命を1にする
3. daisy-toolsを再開させる

備考：

- 細胞が持っていたコード化合物は`code`ディレクトリへ戻される

#### 方法B：細胞ファイルを消す

手順：

1. daisy-toolsを停止させる
2. 対象の細胞ファイルを消す
3. daisy-toolsを再開させる

備考：

- 細胞が持っていたコード化合物ごと消える

## 仕様など

### 現状の`dsy-sysenv`はエラー終了すると`running`ファイルが残るが、特に手動で消す必要は無い

[`dsy-sysenv`の起動時は、`running`ファイルが無ければ作るだけ](https://github.com/cupnes/daisy-tools/blob/c576a5e95a24af27cafe396cfb0dca04771473e4/sysenv.c#L137)

### 突然変異で進化した実行バイナリを評価時に実行することについて

突然変異の仕方によっては↓のようにsegvに陥ることはある

```
bin/dsy-eval: 18 行: 357401 Segmentation fault      ./${TMP_NAME}.elf > ${TMP_NAME}.out 2> /dev/null
```

なお、環境に存在しないコード化合物(命令単位)へは突然変異しない仕様なので、細胞の評価時に意図しない命令が実行されることは無い。

また、`syscall`命令は、事前の`RAX`へのシステムコール番号設定とセットで一つのコード化合物にしておくことで、実行されるシステムコールも制限できる。(少なくとも、`samples`ディレクトリ内の各サンプルで生成されるコード化合物はそのようになっている)

そのため、`dsy-eval`に使うシェルスクリプトやプログラムは、それ自身が何かを標準出力や標準エラー出力へ出力しないようにファイルや`/dev/null`等へリダイレクトしておいたほうが良い。`dsy-eval`が何かを出すと、それがそのまま`dsy-sysenv`や`sample/run`実行時に周期的に画面に出る(`dsy-eval`が周期的に実行されるので)。特に細胞のELF実行時の標準エラー出力はリダイレクトしておく方が良い(segvとか画面に出ることになるのでギョッとする)。

### 突然変異の仕様

突然変異はDNAを構成するコドンの単位で行われる。

突然変異の種別は以下の通り。

- `INSERT_PREV`
- `INSERT_NEXT`
- `MODIFY`
- `REMOVE`
